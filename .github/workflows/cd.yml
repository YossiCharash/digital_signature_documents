# CD â€“ ×¤×¨×™×¡×” ×œ-Render (Deploy Hook). ×¨××• docs/DEPLOY_RENDER.md.
name: CD (Render)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # ============================================
  # Run Tests
  # ============================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio httpx

      - name: Run tests
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=term-missing

  # ============================================
  # Trigger Render Deploy
  # ============================================
  deploy:
    name: Deploy to Render
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Render deploy
        run: |
          if [ -z "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            echo "::warning::RENDER_DEPLOY_HOOK_URL not set. Add it in repo Settings â†’ Secrets and variables â†’ Actions."
            exit 0
          fi
          echo "Triggering Render deploy..."
          resp=$(curl -s -w "\n%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}")
          http_code=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')
          echo "Response ($http_code): $body"
          if [ "$http_code" != "200" ]; then
            echo "::error::Render deploy hook returned HTTP $http_code"
            exit 1
          fi
          echo "Render deploy triggered successfully."

      - name: Deployment summary
        run: |
          echo "## ðŸš€ CD (Render)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Render will build and deploy from \`main\`. Check the [Render Dashboard](https://dashboard.render.com) for build status." >> $GITHUB_STEP_SUMMARY
